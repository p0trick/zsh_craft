name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true
          
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
        
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        
      - name: Build backend for multiple platforms
        working-directory: ./backend
        run: |
          # æž„å»ºå¤šä¸ªå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o zsh_craft_linux_amd64 main.go
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o zsh_craft_linux_arm64 main.go
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o zsh_craft_darwin_amd64 main.go
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o zsh_craft_darwin_arm64 main.go
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o zsh_craft_windows_amd64.exe main.go
          
      - name: Create release assets
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp backend/zsh_craft_* release/
          
          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > release/install.sh << 'EOF'
          #!/bin/bash
          
          # Zsh Craft å®‰è£…è„šæœ¬
          echo "ðŸš€ æ­£åœ¨å®‰è£… Zsh Craft..."
          
          # æ£€æµ‹æ“ä½œç³»ç»Ÿå’Œæž¶æž„
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          case $ARCH in
            x86_64) ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
            arm64) ARCH="arm64" ;;
          esac
          
          # ç¡®å®šå¯æ‰§è¡Œæ–‡ä»¶å
          if [ "$OS" = "darwin" ]; then
            BINARY="zsh_craft_darwin_${ARCH}"
          elif [ "$OS" = "linux" ]; then
            BINARY="zsh_craft_linux_${ARCH}"
          else
            echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS"
            exit 1
          fi
          
          # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$BINARY" ]; then
            echo "âŒ æ‰¾ä¸åˆ°é€‚åˆæ‚¨ç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶: $BINARY"
            echo "å¯ç”¨çš„æ–‡ä»¶:"
            ls -la zsh_craft_*
            exit 1
          fi
          
          # åˆ›å»ºå®‰è£…ç›®å½•
          INSTALL_DIR="/usr/local/bin"
          if [ ! -w "$INSTALL_DIR" ]; then
            echo "éœ€è¦ç®¡ç†å‘˜æƒé™å®‰è£…åˆ° $INSTALL_DIR"
            sudo mkdir -p "$INSTALL_DIR"
          fi
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          if [ -w "$INSTALL_DIR" ]; then
            cp "$BINARY" "$INSTALL_DIR/zsh_craft"
          else
            sudo cp "$BINARY" "$INSTALL_DIR/zsh_craft"
          fi
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          if [ -w "$INSTALL_DIR" ]; then
            chmod +x "$INSTALL_DIR/zsh_craft"
          else
            sudo chmod +x "$INSTALL_DIR/zsh_craft"
          fi
          
          echo "âœ… Zsh Craft å®‰è£…æˆåŠŸï¼"
          echo "ä½¿ç”¨æ–¹æ³•: zsh_craft"
          echo "è®¿é—®åœ°å€: http://localhost:8080"
          EOF
          
          # åˆ›å»ºWindowså®‰è£…è„šæœ¬
          cat > release/install.bat << 'EOF'
          @echo off
          echo ðŸš€ æ­£åœ¨å®‰è£… Zsh Craft...
          
          REM æ£€æµ‹æž¶æž„
          if "%PROCESSOR_ARCHITECTURE%"=="AMD64" (
            set BINARY=zsh_craft_windows_amd64.exe
          ) else (
            set BINARY=zsh_craft_windows_amd64.exe
          )
          
          REM æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if not exist "%BINARY%" (
            echo âŒ æ‰¾ä¸åˆ°é€‚åˆæ‚¨ç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶: %BINARY%
            echo å¯ç”¨çš„æ–‡ä»¶:
            dir zsh_craft_*.exe
            pause
            exit /b 1
          )
          
          REM åˆ›å»ºå®‰è£…ç›®å½•
          set INSTALL_DIR=%PROGRAMFILES%\ZshCraft
          if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
          
          REM å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          copy "%BINARY%" "%INSTALL_DIR%\zsh_craft.exe"
          
          REM æ·»åŠ åˆ°PATH
          setx PATH "%PATH%;%INSTALL_DIR%"
          
          echo âœ… Zsh Craft å®‰è£…æˆåŠŸï¼
          echo ä½¿ç”¨æ–¹æ³•: zsh_craft
          echo è®¿é—®åœ°å€: http://localhost:8080
          pause
          EOF
          
          # åˆ›å»ºREADME
          cat > release/README.md << 'EOF'
          # Zsh Craft Release

          ## å®‰è£…è¯´æ˜Ž

          ### Linux/macOS
          ```bash
          chmod +x install.sh
          ./install.sh
          ```

          ### Windows
          ```cmd
          install.bat
          ```

          ## ä½¿ç”¨æ–¹æ³•

          å®‰è£…å®ŒæˆåŽï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡ï¼š
          ```bash
          zsh_craft
          ```

          ç„¶åŽåœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼šhttp://localhost:8080

          ## æ”¯æŒçš„ç³»ç»Ÿ

          - Linux (amd64, arm64)
          - macOS (amd64, arm64)
          - Windows (amd64)

          ## æ–‡ä»¶è¯´æ˜Ž

          - `zsh_craft_*`: å„å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          - `install.sh`: Linux/macOS å®‰è£…è„šæœ¬
          - `install.bat`: Windows å®‰è£…è„šæœ¬
          - `README.md`: æœ¬è¯´æ˜Žæ–‡ä»¶
          EOF
          
          # è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x release/install.sh
          
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/zsh_craft_*
            release/install.sh
            release/install.bat
            release/README.md
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 